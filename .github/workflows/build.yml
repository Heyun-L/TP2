name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24 ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour rÃ©cupÃ©rer l'historique Git complet
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Install bc calculator
        run: sudo apt-get update && sudo apt-get install -y bc
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test
      
  mutation-testing:
    runs-on: ubuntu-latest
    needs: build
    # Lancer aprÃ¨s le build, mÃªme s'il y a des Ã©checs dans certains modules
    if: always() && (needs.build.result == 'success' || needs.build.result == 'failure')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          java-version: 24
          distribution: temurin
      - name: Install bc calculator
        run: sudo apt-get update && sudo apt-get install -y bc
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/extract_mutation_score.sh
          chmod +x .github/scripts/compare_mutation_scores.sh
      - name: Run PITest mutation testing
        run: |
          echo "ðŸ§¬ Running mutation testing on target classes..."
          # Installer tous les modules dans le repository local pour rÃ©soudre les dÃ©pendances
          mvn -B clean install -DskipTests
          # Puis lancer PITest sur tout le projet (il se concentrera sur nos 2 classes)
          echo "=== Starting PITest ==="
          mvn -B org.pitest:pitest-maven:mutationCoverage -X
          echo "=== PITest completed with exit code: $? ==="
      - name: Debug PITest output structure
        run: |
          echo "=== Checking PITest report generation ==="
          echo "Checking if core/target exists:"
          ls -la core/target/ || echo "âŒ No core/target directory"
          
          echo "Checking if pit-reports exists:"
          ls -la core/target/pit-reports/ || echo "âŒ No pit-reports directory"
          
          echo "Looking for any XML files in target:"
          find core/target -name "*.xml" -type f || echo "âŒ No XML files found"
          
          echo "Looking for any pit-related files:"
          find . -path "*/pit-reports*" -type f || echo "âŒ No pit-report files found"
          
      - name: Extract current mutation score
        id: current_score
        run: |
          echo "=== Extracting mutation score ==="
          if [ -d "core/target/pit-reports" ]; then
            REPORT_DIR=$(ls core/target/pit-reports/ | head -1)
            echo "Found report directory: $REPORT_DIR"
            MUTATIONS_XML="core/target/pit-reports/$REPORT_DIR/mutations.xml"
            echo "Looking for: $MUTATIONS_XML"
            
            if [ -f "$MUTATIONS_XML" ]; then
              CURRENT_SCORE=$(.github/scripts/extract_mutation_score.sh "$MUTATIONS_XML")
              echo "current_score=$CURRENT_SCORE" >> $GITHUB_OUTPUT
              echo "mutations_xml=$MUTATIONS_XML" >> $GITHUB_OUTPUT
              echo "Current mutation score: $CURRENT_SCORE%"
            else
              echo "::error::Mutations XML file not found at: $MUTATIONS_XML"
              echo "Contents of report directory:"
              ls -la "core/target/pit-reports/$REPORT_DIR/" || echo "Directory does not exist"
              echo "All files in pit-reports:"
              find core/target/pit-reports/ -type f || echo "No files found"
              echo "PITest may have failed to generate XML - checking PITest logs..."
              exit 1
            fi
          else
            echo "::error::No pit-reports directory found"
            exit 1
          fi
      - name: Get baseline mutation score from main branch
        id: baseline_score
        run: |
          # DÃ©finir un score de base par dÃ©faut (peut Ãªtre ajustÃ©)
          DEFAULT_BASELINE="55.0"
          
          # Essayer de rÃ©cupÃ©rer le score de la branche principale
          if git show origin/main:.github/mutation-baseline.txt > /dev/null 2>&1; then
            BASELINE_SCORE=$(git show origin/main:.github/mutation-baseline.txt)
            echo "Found baseline score from main branch: $BASELINE_SCORE%"
          else
            BASELINE_SCORE="$DEFAULT_BASELINE"
            echo "No baseline found, using default: $BASELINE_SCORE%"
          fi
          
          echo "baseline_score=$BASELINE_SCORE" >> $GITHUB_OUTPUT
      - name: Compare mutation scores
        run: |
          BASELINE="${{ steps.baseline_score.outputs.baseline_score }}"
          CURRENT="${{ steps.current_score.outputs.current_score }}"
          .github/scripts/compare_mutation_scores.sh "$BASELINE" "$CURRENT"
      - name: Update baseline if on main branch
        if: github.ref == 'refs/heads/main' && steps.current_score.outputs.current_score != ''
        run: |
          echo "${{ steps.current_score.outputs.current_score }}" > .github/mutation-baseline.txt
          echo "Updated baseline score to: ${{ steps.current_score.outputs.current_score }}%"
      - name: Upload mutation testing reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-test-reports-java-24
          path: |
            core/target/pit-reports/
          retention-days: 30
      - name: Comment PR with mutation test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const baseline = '${{ steps.baseline_score.outputs.baseline_score }}';
            const current = '${{ steps.current_score.outputs.current_score }}';
            const mutationsXml = '${{ steps.current_score.outputs.mutations_xml }}';
            
            let comment = `## ðŸ§¬ Mutation Testing Results\n\n`;
            comment += `| Metric | Value |\n`;
            comment += `|--------|-------|\n`;
            comment += `| Baseline Score | ${baseline}% |\n`;
            comment += `| Current Score | ${current}% |\n`;
            
            const currentNum = parseFloat(current);
            const baselineNum = parseFloat(baseline);
            
            if (currentNum < baselineNum) {
              const decrease = (baselineNum - currentNum).toFixed(2);
              comment += `| Status | âŒ **Decreased by ${decrease}%** |\n\n`;
              comment += `âš ï¸  **Mutation score regression detected!** Please review your changes to ensure test quality is maintained.\n\n`;
            } else if (currentNum > baselineNum) {
              const increase = (currentNum - baselineNum).toFixed(2);
              comment += `| Status | ðŸŽ‰ **Improved by ${increase}%** |\n\n`;
              comment += `âœ… Great job! Your changes have improved the mutation test coverage.\n\n`;
            } else {
              comment += `| Status | âœ… **Maintained** |\n\n`;
              comment += `âœ… Mutation score maintained at the current level.\n\n`;
            }
            
            comment += `### Details\n`;
            comment += `- **Target Classes**: \`DistanceCalcEuclidean\`, \`Circle\`\n`;
            comment += `- **Test Classes**: \`DistanceCalcEuclideanTest\`, \`CircleTest\`\n`;
            comment += `- **Mutation Report**: Available in build artifacts\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

