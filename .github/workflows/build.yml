name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24 ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour rÃ©cupÃ©rer l'historique Git complet
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Install bc calculator
        run: sudo apt-get update && sudo apt-get install -y bc
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test
      
      - name: Rickroll on test failure
        if: failure()
        run: |
          echo "Tests failed! Here's something to cheer you up:"
          echo "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
          echo "Never Gonna Give You Up! ðŸŽ¤"
      
  mutation-testing:
    runs-on: ubuntu-latest
    needs: build
    # Lancer aprÃ¨s le build, mÃªme s'il y a des Ã©checs dans certains modules
    if: always() && (needs.build.result == 'success' || needs.build.result == 'failure')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          java-version: 24
          distribution: temurin
      - name: Install bc calculator
        run: sudo apt-get update && sudo apt-get install -y bc
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Run PITest mutation testing
        run: |
          echo "Running mutation testing on target classes"
          # Installer tous les modules dans le repository local pour rÃ©soudre les dÃ©pendances
          mvn -B clean install -DskipTests
          # Compiler les classes de test du module core
          echo "Compiling test classes"
          cd core
          mvn -B test-compile
          
          # VÃ©rifier que les classes cibles existent
          echo "Verifying target classes exist"
          ls -la target/classes/com/graphhopper/util/DistanceCalcEuclidean.class || echo "DistanceCalcEuclidean not found"
          ls -la target/classes/com/graphhopper/util/shapes/Circle.class || echo "Circle not found"
          ls -la target/test-classes/com/graphhopper/util/DistanceCalcEuclideanTest.class || echo "DistanceCalcEuclideanTest not found"
          ls -la target/test-classes/com/graphhopper/util/shapes/CircleTest.class || echo "CircleTest not found"
          
          # Lancer PITest directement dans le module core
          echo "Starting PITest"
          mvn -B org.pitest:pitest-maven:mutationCoverage -DtimeoutFactor=2 2>&1 | tee pitest-output.log
          PITEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "PITest completed with exit code: $PITEST_EXIT_CODE"
          
          # Afficher les derniÃ¨res lignes pour debug
          echo "Last 50 lines of PITest output"
          tail -50 pitest-output.log
          
          exit $PITEST_EXIT_CODE
      - name: Debug PITest output structure
        run: |
          echo "Checking PITest report generation"
          echo "Checking if core/target exists:"
          ls -la core/target/ || echo "No core/target directory"
          
          echo "Checking if pit-reports exists:"
          ls -la core/target/pit-reports/ || echo "No pit-reports directory"
          
          echo "Contents of EACH report directory:"
          for dir in core/target/pit-reports/*/; do
            echo "Directory: $dir"
            ls -laR "$dir" || echo "Cannot list $dir"
          done
          
          echo "Looking for any XML files in target:"
          find core/target -name "*.xml" -type f || echo "No XML files found"
          
      - name: Extract current mutation score
        id: current_score
        shell: bash
        run: |
          echo "Extracting mutation score"
          REPORT_DIR=$(ls core/target/pit-reports/ | head -1)
          MUTATIONS_XML="core/target/pit-reports/$REPORT_DIR/mutations.xml"
          echo "Found mutations.xml at: $MUTATIONS_XML"
          
          # Utiliser Python pour parser le XML de maniÃ¨re fiable
          MUTATION_SCORE=$(python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('$MUTATIONS_XML')
          root = tree.getroot()
          mutations = root.findall('mutation')
          total = len(mutations)
          killed = sum(1 for m in mutations if m.get('status') == 'KILLED')
          score = (killed * 100.0 / total) if total > 0 else 0
          print(f'{score:.2f}')
          ")
          
          echo "Mutation score: $MUTATION_SCORE%"
          echo "current_score=$MUTATION_SCORE" >> $GITHUB_OUTPUT
          echo "mutations_xml=$MUTATIONS_XML" >> $GITHUB_OUTPUT
      - name: Get baseline mutation score from main branch
        id: baseline_score
        run: |
          # DÃ©finir un score de base par dÃ©faut (peut Ãªtre ajustÃ©)
          DEFAULT_BASELINE="55.0"
          
          # Essayer de rÃ©cupÃ©rer le score de la branche principale
          if git show origin/main:.github/mutation-baseline.txt > /dev/null 2>&1; then
            BASELINE_SCORE=$(git show origin/main:.github/mutation-baseline.txt)
            echo "Found baseline score from main branch: $BASELINE_SCORE%"
          else
            BASELINE_SCORE="$DEFAULT_BASELINE"
            echo "No baseline found, using default: $BASELINE_SCORE%"
          fi
          
          echo "baseline_score=$BASELINE_SCORE" >> $GITHUB_OUTPUT
      - name: Compare mutation scores
        run: |
          BASELINE="${{ steps.baseline_score.outputs.baseline_score }}"
          CURRENT="${{ steps.current_score.outputs.current_score }}"
          
          echo "Mutation Testing Analysis"
          echo "Baseline score: $BASELINE%"
          echo "Current score:  $CURRENT%"
          
          # Comparer les scores
          DIFF=$(awk "BEGIN {printf \"%.2f\", $CURRENT - $BASELINE}")
          
          if (( $(awk "BEGIN {print ($CURRENT < $BASELINE)}") )); then
            echo "FAILURE: Mutation score has decreased by ${DIFF#-} percentage points"
            echo "::error::Mutation score regression detected: $CURRENT% < $BASELINE%"
            exit 1
          elif (( $(awk "BEGIN {print ($CURRENT > $BASELINE)}") )); then
            echo "SUCCESS: Mutation score has improved by $DIFF percentage points"
          else
            echo "SUCCESS: Mutation score maintained at $BASELINE%"
          fi
      - name: Update baseline if on main branch
        if: github.ref == 'refs/heads/main' && steps.current_score.outputs.current_score != ''
        run: |
          echo "${{ steps.current_score.outputs.current_score }}" > .github/mutation-baseline.txt
          echo "Updated baseline score to: ${{ steps.current_score.outputs.current_score }}%"
      - name: Upload mutation testing reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-test-reports-java-24
          path: |
            core/target/pit-reports/
          retention-days: 30
      - name: Comment PR with mutation test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const baseline = '${{ steps.baseline_score.outputs.baseline_score }}';
            const current = '${{ steps.current_score.outputs.current_score }}';
            const mutationsXml = '${{ steps.current_score.outputs.mutations_xml }}';
            
            let comment = `## Mutation Testing Results\n\n`;
            comment += `| Metric | Value |\n`;
            comment += `|--------|-------|\n`;
            comment += `| Baseline Score | ${baseline}% |\n`;
            comment += `| Current Score | ${current}% |\n`;
            
            const currentNum = parseFloat(current);
            const baselineNum = parseFloat(baseline);
            
            if (currentNum < baselineNum) {
              const decrease = (baselineNum - currentNum).toFixed(2);
              comment += `| Status | **Decreased by ${decrease}%** |\n\n`;
              comment += `Mutation score regression detected. Please review your changes to ensure test quality is maintained.\n\n`;
            } else if (currentNum > baselineNum) {
              const increase = (currentNum - baselineNum).toFixed(2);
              comment += `| Status | **Improved by ${increase}%** |\n\n`;
              comment += `Great job! Your changes have improved the mutation test coverage.\n\n`;
            } else {
              comment += `| Status | **Maintained** |\n\n`;
              comment += `Mutation score maintained at the current level.\n\n`;
            }
            
            comment += `### Details\n`;
            comment += `- **Target Classes**: \`DistanceCalcEuclidean\`, \`Circle\`\n`;
            comment += `- **Test Classes**: \`DistanceCalcEuclideanTest\`, \`CircleTest\`\n`;
            comment += `- **Mutation Report**: Available in build artifacts\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

